package com.nisovin.magicspells.spells.buff;

import java.util.HashSet;
import java.util.List;

import org.bukkit.entity.Entity;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.entity.EntityDamageEvent;
import org.bukkit.event.entity.EntityDamageEvent.DamageCause;

import com.nisovin.magicspells.spells.BuffSpell;
import com.nisovin.magicspells.util.ConfigData;
import com.nisovin.magicspells.util.MagicConfig;

public class InvulnerabilitySpell extends BuffSpell {

	@ConfigData(field="damage-causes", dataType="String[]", defaultValue="null")
	private HashSet<DamageCause> damageCauses;
	
	private HashSet<String> gods;
	
	public InvulnerabilitySpell(MagicConfig config, String spellName) {
		super(config, spellName);
		
		this.damageCauses = new HashSet<>();
		List<String> causes = getConfigStringList("damage-causes", null);
		if (causes != null) {
			for (String s : causes) {
				s = s.replace(" ","_").replace("-","_").toUpperCase();
				DamageCause cause = DamageCause.valueOf(s);
				if (cause == null) continue;
				this.damageCauses.add(cause);
			}
		}
		
		this.gods = new HashSet<>();
	}

	@Override
	public boolean castBuff(Player player, float power, String[] args) {
		this.gods.add(player.getName());
		return true;
	}

	@EventHandler
	public void onEntityDamage(EntityDamageEvent event) {
		if (event.isCancelled()) return;
		Entity entity = event.getEntity();
		if (!(entity instanceof Player)) return;
		// TODO flatten this
		if (this.damageCauses.isEmpty() || this.damageCauses.contains(event.getCause())) {
			Player player = (Player)entity;
			if (this.gods.contains(player.getName())) {
				if (isExpired(player)) {
					turnOff(player);
				} else {
					event.setCancelled(true);
					if (player.getNoDamageTicks() < player.getMaximumNoDamageTicks() / 2.0F) {
						addUseAndChargeCost(player);
					}
				}
			}
		}
	}
	
	@Override
	public void turnOffBuff(Player player) {
		this.gods.remove(player.getName());
	}
	
	@Override
	protected void turnOff() {
		this.gods.clear();
	}

	@Override
	public boolean isActive(Player player) {
		return this.gods.contains(player.getName());
	}

}
